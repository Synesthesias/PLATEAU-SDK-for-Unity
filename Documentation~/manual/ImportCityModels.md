# 都市モデルのインポート

このページでは、都市データをUnityプロジェクトにインポートする手順を説明します。

## 準備
- 都市データを用意します。   
  これは国土交通省のPLATEAUのWebサイトからダウンロードできます。  
- PlateauSDK を導入したUnityプロジェクトを用意します。  
  SDKの導入方法は [インストール](Installation.md) を参照してください。

## インポート手順
### インポート元の選択
- Unityのメニューバーから ```PLATEAU → 都市モデルをインポート``` を選択します。   
  するとインポートウィンドウが表示されます。
- ```参照```ボタンから都市データを選択します。   
  都市データの中に```udx```という名称のフォルダがあるので、それを選択します。

>[!NOTE]
> udx と同じディレクトリに codelists という名称のフォルダがあります。こちらもインポート時に必要です。

### インポート対象の絞り込み
- インポートする対象を選択します。  
  地域IDと地物タイプのチェックボックスで対象を絞り込むことができます。

### 出力先の選択
- 出力先はUnityプロジェクトのAssetsフォルダの内部である必要があります。  
  ここで選択したフォルダに、 gml ファイルを変換した 3Dモデル(.obj形式)ファイル および メタデータが出力されます。

>[!NOTE]
>   ここで選択したフォルダとは別に、インポート元となる都市データも合わせてUnityプロジェクト内にコピーされます。  
>   こちらのコピー先は、上の設定に関わらず ```Assets/StreamingAssets/PLATEAU``` になります。  
>   こうする意図は、Unityアプリケーションの実行中にgmlファイルのデータを取得する目的で、gmlファイルを StreamingAssetsフォルダに配置する必要があるためです。  
>   なお、インポート対象として選択したものに関連するもののみがコピーされます。

### 変換設定  
- **最適化**
  - 通常ONで大丈夫です。  
  - // TODO 最適化で何が変わるのかよく分かっていません。利用ライブラリに「最適化」の項目があったので選択式にしてみましたが、大きな差がるようには見えません。
- **メッシュのオブジェクト分けの粒度**
  - **PerPrimaryFeatureObject**
    - 建物ごとにデータを取得できるようにしたい場合はデフォルト設定であるこちらを選択します。
  - **PerAtomicFeatureObject**
    - 屋根、壁単位など非常に細かくオブジェクトを分けたい特段の事情がある場合はを選択します。  
  - **PerCityModelArea**
    - 軽量化の都合でオブジェクト数を削減したい場合は、建物ごとのデータは取得できなくなりますが、こちらを選択することで1つのgml内のオブジェクトがすべて結合されて出力されます。

### インポートの実行と確認
  - ```出力```ボタンを押してインポートを実行します。
  - 出力結果を確認します。
     - 3Dモデルファイル(.obj形式)が出力先に配置されます。
     - 変換したモデルがUnityのシーンに自動で配置されます。
     - 変換元ファイルが ```Assets/StreamingAssets/PLATEAU``` にコピーされています。
     - メタデータが出力先に配置されます。

>[!NOTE]
> メタデータを選択すると再変換の画面がインスペクタに表示されます。  
> メタデータはインポート時の設定を覚えているので、「設定を少し変えて再変換」する操作が便利にできるようになっています。  
> また、再変換時はシーンに配置されたモデルも置き換わります。


### エラーログの確認

ロードに失敗したgmlファイルがある場合、Unityのコンソールにエラーログが出力されます。  
そのような場合でも、一部のgmlファイルのロードが成功していれば、そのgmlに関しては正常にインポートされています。  
複数のエラーログが出力されるので、その見方をこの項で説明します。
- 失敗・成功の件数を確認するには
  - 複数あるエラーログのうち、最後のものを確認すると次のメッセージがあります。  
    ```Convert end with error. (失敗件数) of (全体件数) gml files are not converted.```  
    これにより失敗件数が分かります。また、残りのgmlファイルは正常にインポートできたことが分かります。
- どのgmlファイルでなぜ失敗したのか確認するには
  - 次のエラーメッセージで、どのgmlファイルで失敗したかを確認できます。  
    ```Loading gml failed. gml path =(gmlファイルの場所)``` または  
    ```Gml to obj convert is Failed. gml path =(gmlファイルの場所)```  
  - 上記のエラーログの直前のエラーは、通常そのgmlファイルのロードに失敗した理由を示します。